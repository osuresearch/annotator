"use strict";(self.webpackChunk_osuresearch_annotator=self.webpackChunk_osuresearch_annotator||[]).push([[479],{"./src/components/Annotations/Annotations.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{u:()=>Annotations});var react=__webpack_require__("./node_modules/react/index.js"),index_module=__webpack_require__("./node_modules/@osuresearch/ui/dist/index.module.js"),dist_import=__webpack_require__("./node_modules/@react-aria/focus/dist/import.mjs"),useAnnotationsContext=__webpack_require__("./src/hooks/useAnnotationsContext.ts");function useThread(id){const{annotations,createThread,createReply,updateBody,focused,patch,focus}=(0,useAnnotationsContext.i)(),[thread,setThread]=(0,react.useState)(),[replies,setReplies]=(0,react.useState)([]);return(0,react.useEffect)((()=>{const match=annotations.find((t=>t.id===id));match&&match!==thread&&setThread(match);const replies=annotations.filter((a=>a.target.source===id));setReplies(replies),console.log("useThread effect ",id)}),[annotations]),(0,react.useMemo)((()=>({thread,focused:focused?.id===id,replies,focus:()=>{thread&&focus(thread.id)},updateComment:message=>{thread&&updateBody("TextualBody",thread.id,(prev=>({...prev,value:message})))},remove:(recoverable=!0)=>{thread&&updateBody("Thread",thread.id,(prev=>({...prev,deleted:!0,recoverable})))},recover:()=>{thread&&updateBody("Thread",thread.id,(prev=>({...prev,deleted:!1})))},resolve:()=>{thread&&updateBody("Thread",thread.id,(prev=>({...prev,resolved:!0})))},reopen:()=>{thread&&updateBody("Thread",thread.id,(prev=>({...prev,resolved:!1})))},addReply:message=>{if(!thread)throw new Error("Invalid thread");const reply=createReply(thread.id,message);return updateBody("Thread",thread.id,(prev=>({...prev}))),reply},updateReply:(id,message)=>{if(replies.findIndex((r=>r.id===id))<0)throw new Error(`Could not update reply: annotation ${id} is not a reply to ${thread?.id}`);updateBody("TextualBody",id,(prev=>({...prev,value:message})))},removeReply:(id,recoverable=!0)=>{if(replies.findIndex((r=>r.id===id))<0)throw new Error(`Could not remove reply: annotation ${id} is not a reply to ${thread?.id}`);updateBody("ThreadReply",id,(prev=>({...prev,deleted:!0,recoverable})))},recoverReply:id=>{if(replies.findIndex((r=>r.id===id))<0)throw new Error(`Could not recover reply: annotation ${id} is not a reply to ${thread?.id}`);updateBody("ThreadReply",id,(prev=>({...prev,deleted:!1})))}})),[thread,replies,patch,focus])}var useAnchorsContext=__webpack_require__("./src/hooks/useAnchorsContext.ts"),interactions_dist_import=__webpack_require__("./node_modules/@react-aria/interactions/dist/import.mjs"),dist=__webpack_require__("./node_modules/@tiptap/react/dist/index.js"),extension_placeholder_dist=__webpack_require__("./node_modules/@tiptap/extension-placeholder/dist/index.js"),starter_kit_dist=__webpack_require__("./node_modules/@tiptap/starter-kit/dist/index.js"),parse_hotkey=__webpack_require__("./node_modules/@mantine/hooks/esm/use-hotkeys/parse-hotkey.js"),jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function EditableMessage({defaultValue,placeholder,autosave=!1,onSave,onCancel}){const{focusWithinProps}=(0,interactions_dist_import.L_)({onBlurWithin:e=>{autosave?handleSave():handleCancel()}}),editor=(0,dist.jE)({content:defaultValue,extensions:[starter_kit_dist.Z,extension_placeholder_dist.Z.configure({placeholder})]},[]),handleSave=()=>{if(!editor)return;const content=editor.getHTML();editor.chain().clearContent().blur().run(),onSave(content)},handleCancel=()=>{editor&&(editor.chain().clearContent().blur().run(),onCancel())};return(0,react.useEffect)((()=>{editor&&editor.commands.focus("end")}),[editor]),(0,jsx_runtime.jsx)(dist_import.MT,{contain:!0,restoreFocus:!0,autoFocus:!0,children:(0,jsx_runtime.jsxs)(index_module.Kq,{align:"stretch",...focusWithinProps,children:[(0,jsx_runtime.jsxs)(index_module.xu,{p:"xs",className:"rui-border-2",children:[(0,jsx_runtime.jsx)(dist.kg,{editor,onKeyDown:(0,parse_hotkey.yr)([["mod+Enter",handleSave]])}),"Hotkey: mod+Enter to save"]}),(0,jsx_runtime.jsxs)(index_module.ZA,{justify:"end",children:[(0,jsx_runtime.jsx)(index_module.zx,{onPress:handleSave,children:"Save"}),(0,jsx_runtime.jsx)(index_module.zx,{onPress:handleCancel,children:"Cancel"})]})]})})}EditableMessage.displayName="EditableMessage";try{EditableMessage.displayName="EditableMessage",EditableMessage.__docgenInfo={description:"Rich text editor with a save/cancel button visible on mount.\n\na11y\n- Focuses on the text input on mount\n- Traps keyboard focus until closed",displayName:"EditableMessage",props:{defaultValue:{defaultValue:null,description:"",name:"defaultValue",required:!0,type:{name:"string"}},placeholder:{defaultValue:null,description:"",name:"placeholder",required:!1,type:{name:"string"}},autosave:{defaultValue:{value:"false"},description:"",name:"autosave",required:!1,type:{name:"boolean"}},onSave:{defaultValue:null,description:"",name:"onSave",required:!0,type:{name:"(value: string) => void"}},onCancel:{defaultValue:null,description:"",name:"onCancel",required:!0,type:{name:"() => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/EditableMessage.tsx#EditableMessage"]={docgenInfo:EditableMessage.__docgenInfo,name:"EditableMessage",path:"src/components/Thread/EditableMessage.tsx#EditableMessage"})}catch(__react_docgen_typescript_loader_error){}function Profile({node,showRole}){const body=node.body.find((b=>"ThreadReply"===b.type||"Thread"===b.type)),role=body?body.role:"";return(0,jsx_runtime.jsxs)(index_module.ZA,{align:"center",gap:"xxs",children:[(0,jsx_runtime.jsx)(index_module.qE,{alt:node.creator.name,size:24,name:node.creator.name,opicUsername:node.creator.nickname,style:{marginLeft:-28}}),(0,jsx_runtime.jsx)(index_module.xv,{fw:"bold",fs:"sm",children:node.creator.name}),showRole&&role&&(0,jsx_runtime.jsx)(index_module.Af,{variant:"outline",c:"blue",children:role})]})}Profile.displayName="Profile";try{Profile.displayName="Profile",Profile.__docgenInfo={description:"",displayName:"Profile",props:{node:{defaultValue:null,description:"",name:"node",required:!0,type:{name:"Annotation"}},showRole:{defaultValue:null,description:"",name:"showRole",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/Profile.tsx#Profile"]={docgenInfo:Profile.__docgenInfo,name:"Profile",path:"src/components/Thread/Profile.tsx#Profile"})}catch(__react_docgen_typescript_loader_error){}function ReadOnlyMessage({message}){return(0,jsx_runtime.jsx)(index_module.xv,{fs:"sm",children:(0,jsx_runtime.jsx)("span",{dangerouslySetInnerHTML:{__html:message}})})}ReadOnlyMessage.displayName="ReadOnlyMessage";try{ReadOnlyMessage.displayName="ReadOnlyMessage",ReadOnlyMessage.__docgenInfo={description:"",displayName:"ReadOnlyMessage",props:{message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/ReadOnlyMessage.tsx#ReadOnlyMessage"]={docgenInfo:ReadOnlyMessage.__docgenInfo,name:"ReadOnlyMessage",path:"src/components/Thread/ReadOnlyMessage.tsx#ReadOnlyMessage"})}catch(__react_docgen_typescript_loader_error){}const Reply=react.forwardRef((({thread,node},ref)=>{const{focused,replies,updateReply,removeReply,recoverReply}=useThread(thread.id),[isEditing,setEditing]=(0,react.useState)(!1),body=node.body.find((b=>"TextualBody"===b.type)),state=node.body.find((b=>"ThreadReply"===b.type)),threadState=thread.body.find((b=>"Thread"===b.type)),defaultValue=body.value,{deleted,recoverable}=state,{resolved}=threadState;let isFirstFromPerson=node.creator.id!==thread.creator.id,found=!1;return replies.forEach((r=>{found||(r.id!==node.id?r.creator.id===node.creator.id&&(isFirstFromPerson=!1):found=!0)})),deleted&&recoverable?(0,jsx_runtime.jsxs)(index_module.xv,{p:"xs",fs:"sm",children:["Deleted reply."," ",(0,jsx_runtime.jsx)(index_module.rU,{as:"button",onClick:()=>recoverReply(node.id),children:"(undo)"})]}):deleted?null:(0,jsx_runtime.jsx)(index_module.Xk,{ml:"sm",mt:"sm",children:(0,jsx_runtime.jsxs)(index_module.Kq,{align:"stretch",gap:0,pl:"xs",tabIndex:0,children:[(0,jsx_runtime.jsxs)(index_module.ZA,{justify:"apart",align:"center",children:[(0,jsx_runtime.jsx)(Profile,{node,showRole:!isFirstFromPerson}),!resolved&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(index_module.hU,{size:16,iconProps:{p:"xxs"},name:"edit",label:"Edit reply",onPress:()=>setEditing(!0)}),(0,jsx_runtime.jsx)(index_module.v2,{label:"More actions",onAction:key=>("delete"===key&&removeReply(node.id),!0),children:(0,jsx_runtime.jsx)(index_module.ck,{children:"Delete reply"},"delete")})]})]}),isEditing?(0,jsx_runtime.jsx)(EditableMessage,{defaultValue,onSave:message=>{updateReply(node.id,message),setEditing(!1)},onCancel:()=>setEditing(!1)}):(0,jsx_runtime.jsx)(ReadOnlyMessage,{message:defaultValue}),focused&&!isEditing&&(0,jsx_runtime.jsx)(index_module.xv,{c:"dark",fs:"xs",children:new Date(node.created).toLocaleString()})]})})}));try{Reply.displayName="Reply",Reply.__docgenInfo={description:"Render a comment as a reply to a thread",displayName:"Reply",props:{thread:{defaultValue:null,description:"",name:"thread",required:!0,type:{name:"Annotation"}},node:{defaultValue:null,description:"",name:"node",required:!0,type:{name:"Annotation"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/Reply.tsx#Reply"]={docgenInfo:Reply.__docgenInfo,name:"Reply",path:"src/components/Thread/Reply.tsx#Reply"})}catch(__react_docgen_typescript_loader_error){}function StartReply({thread}){const[active,setActive]=(0,react.useState)(!1),{addReply}=useThread(thread.id);return(0,jsx_runtime.jsxs)(index_module.Kq,{align:"stretch",children:[!active&&(0,jsx_runtime.jsx)(index_module.kG,{className:"rui-border-2",p:"xs",onPress:()=>setActive(!0),children:(0,jsx_runtime.jsx)(index_module.ZA,{children:"Reply"})}),active&&(0,jsx_runtime.jsx)(EditableMessage,{placeholder:"Reply",onSave:message=>{addReply(message),setActive(!1)},onCancel:()=>setActive(!1),defaultValue:""})]})}StartReply.displayName="StartReply";try{StartReply.displayName="StartReply",StartReply.__docgenInfo={description:"",displayName:"StartReply",props:{thread:{defaultValue:null,description:"",name:"thread",required:!0,type:{name:"Annotation"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/StartReply.tsx#StartReply"]={docgenInfo:StartReply.__docgenInfo,name:"StartReply",path:"src/components/Thread/StartReply.tsx#StartReply"})}catch(__react_docgen_typescript_loader_error){}var utils=__webpack_require__("./src/utils.ts"),data_dist_import=__webpack_require__("./node_modules/@react-stately/data/dist/import.mjs");const Context=(0,react.createContext)({});var styled_components_browser_esm=__webpack_require__("./node_modules/styled-components/dist/styled-components.browser.esm.js");styled_components_browser_esm.ZP.div`
  position: absolute;
  width: 100vw;
  top: 0;
  left: 0;
  margin-left: -30em;
  border-top: 1px solid black;
  background-color: #eee;
`;const Container=styled_components_browser_esm.ZP.div`
  position: absolute;
  border: 1px solid red;
  top: 0;
  margin-top: -20px;
`;function AnchoredContainer({id,el,focused,children}){const ref=(0,react.useRef)(null),{items,getItem,addItem,removeItem,updateItem,focus}=(0,react.useContext)(Context),[top,setTop]=(0,react.useState)(0),[height,setHeight]=(0,react.useState)(0);(0,react.useLayoutEffect)((()=>{if(!el||!ref.current)return;const anchorCell=Math.round((0,utils.m)(el).top),height=ref.current.offsetHeight;return addItem({id,anchorCell,cell:anchorCell,height}),setTop(anchorCell),setHeight(height),()=>{removeItem(id)}}),[id,el,ref]);const item=getItem(id);return(0,react.useEffect)((()=>{const item=getItem(id);item&&(item.cell!==top&&(console.log("update top",el?.id,item.cell),setTop(item.cell)),item.height!==height&&updateItem(id,{...item,height}))}),[items,top,height,id]),(0,react.useEffect)((()=>{let prevTop=0;const handle=setInterval((()=>{if(!el)return void console.log("no el");const top=Math.round((0,utils.m)(el).top);if(top===prevTop)return void console.log("same top");const item=getItem(id);item&&top!==item.anchorCell&&(console.log("Update top",el.id,prevTop,top,id),prevTop=top,updateItem(id,{...item,anchorCell:top}))}),1e3);return()=>clearInterval(handle)}),[id,item]),(0,react.useEffect)((()=>{if(!ref.current)return;const container=ref.current,observer=new ResizeObserver((()=>{if(!ref.current||!item)return;const newHeight=ref.current.offsetHeight;newHeight!==item.height&&setHeight(newHeight)}));return observer.observe(container),()=>observer.unobserve(container)}),[id,ref,item]),(0,react.useEffect)((()=>{if(focused){const item=getItem(id);if(!item||item.cell===item.anchorCell)return;updateItem(id,{...item,cell:item.anchorCell})}}),[items,id,focused]),(0,jsx_runtime.jsx)(Container,{ref,style:{top},children})}AnchoredContainer.displayName="AnchoredContainer";try{AnchoredContainer.displayName="AnchoredContainer",AnchoredContainer.__docgenInfo={description:"Responsible for keeping body content aligned with a target anchor.",displayName:"AnchoredContainer",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},el:{defaultValue:null,description:"",name:"el",required:!1,type:{name:"HTMLElement"}},focused:{defaultValue:null,description:"",name:"focused",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/AnchoredContainer.tsx#AnchoredContainer"]={docgenInfo:AnchoredContainer.__docgenInfo,name:"AnchoredContainer",path:"src/components/Thread/AnchoredContainer.tsx#AnchoredContainer"})}catch(__react_docgen_typescript_loader_error){}function Thread({node}){const ref=(0,react.useRef)(null),{getAnchor}=(0,useAnchorsContext.T)(),anchor=getAnchor({source:node.target.source}),{focused,replies,focus,updateComment,resolve,reopen,remove,recover}=useThread(node.id),[isEditing,setEditing]=(0,react.useState)(!1),[isAutofocus,setAutofocus]=(0,react.useState)(!1),body=node.body.find((b=>"TextualBody"===b.type)),state=node.body.find((b=>"Thread"===b.type)),defaultValue=body.value,{deleted,recoverable,resolved}=state,isInitial=defaultValue.trim().length<1;(0,react.useLayoutEffect)((()=>{ref.current&&focused&&isInitial&&(setEditing(!0),setAutofocus(!0))}),[node,ref,focused,isInitial]);return deleted&&recoverable?(0,jsx_runtime.jsxs)(index_module.Xk,{withBorder:!0,p:"xs",children:["Deleted thread."," ",(0,jsx_runtime.jsx)(index_module.rU,{as:"button",onClick:recover,children:"(undo)"})]}):deleted?null:(0,jsx_runtime.jsx)(dist_import.MT,{children:(0,jsx_runtime.jsx)(AnchoredContainer,{id:node.id,el:anchor?.target,focused,children:(0,jsx_runtime.jsx)(index_module.Xk,{id:"thread-"+node.id,p:"xs",ml:"sm",ref,tabIndex:0,onClick:focus,className:(0,index_module.cx)({"rui-border-2":!0,"rui-border-light":!focused,"rui-border-blue":focused}),children:(0,jsx_runtime.jsxs)(index_module.Kq,{align:"stretch",gap:0,pl:"xs",children:[resolved&&(0,jsx_runtime.jsxs)(index_module.ZA,{justify:"apart",align:"center",children:[(0,jsx_runtime.jsx)(Profile,{node}),(0,jsx_runtime.jsxs)(index_module.ZA,{align:"center",children:[(0,jsx_runtime.jsxs)(index_module.Af,{variant:"outline",c:"green",children:[(0,jsx_runtime.jsx)(index_module.JO,{name:"check"})," resolved"]}),(0,jsx_runtime.jsx)(index_module.hU,{size:16,iconProps:{p:"xxs"},name:"rotate",label:"Reopen",onPress:reopen})]})]}),!resolved&&(0,jsx_runtime.jsxs)(index_module.ZA,{justify:"apart",align:"center",children:[(0,jsx_runtime.jsx)(Profile,{node,showRole:!0}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(index_module.hU,{size:16,iconProps:{p:"xxs"},name:"edit",label:"Edit comment",onPress:()=>setEditing(!0)}),(0,jsx_runtime.jsxs)(index_module.v2,{label:"More actions",onAction:key=>("resolve"===key?resolve():"delete"===key&&remove(),!0),children:[(0,jsx_runtime.jsx)(index_module.ck,{children:"Link to thread"},"link"),(0,jsx_runtime.jsx)(index_module.ck,{children:"Resolve thread"},"resolve"),(0,jsx_runtime.jsx)(index_module.ck,{children:"Delete thread"},"delete")]})]})]}),isEditing?(0,jsx_runtime.jsx)(EditableMessage,{defaultValue,autosave:isAutofocus,onSave:message=>{"<p></p>"===message.trim()&&(message=""),updateComment(message),setEditing(!1),!message.length&&message.length<1&&remove(!1)},onCancel:()=>{setEditing(!1),defaultValue.length<1&&replies.length<1&&remove(!1)}}):(0,jsx_runtime.jsx)(ReadOnlyMessage,{message:defaultValue}),focused&&!isEditing&&(0,jsx_runtime.jsx)(index_module.xv,{c:"dark",fs:"xs",children:new Date(node.created).toLocaleString()}),resolved&&replies.length>0&&!focused&&(0,jsx_runtime.jsx)(index_module.xv,{fs:"xs",fw:"bold",children:1===replies.length?"1 more reply":replies.length+" more replies"}),(!resolved||focused)&&replies.map((reply=>(0,jsx_runtime.jsx)(Reply,{thread:node,node:reply},reply.id))),!resolved&&!isInitial&&(0,jsx_runtime.jsx)(StartReply,{thread:node})]})})})})}Thread.displayName="Thread";try{Thread.displayName="Thread",Thread.__docgenInfo={description:"",displayName:"Thread",props:{node:{defaultValue:null,description:"",name:"node",required:!0,type:{name:"Annotation"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Thread/Thread.tsx#Thread"]={docgenInfo:Thread.__docgenInfo,name:"Thread",path:"src/components/Thread/Thread.tsx#Thread"})}catch(__react_docgen_typescript_loader_error){}function Annotations_Debug(){const{annotations,focused}=(0,useAnnotationsContext.i)(),{items}=(0,useAnchorsContext.T)();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)(index_module.PO,{summary:"🔧 Annotations",children:[focused?"Focused: "+focused.id:"No focused annotation",(0,jsx_runtime.jsx)(index_module.EK,{block:!0,children:JSON.stringify(annotations,void 0,2)})]}),(0,jsx_runtime.jsx)(index_module.PO,{summary:"🔧 Anchors",children:(0,jsx_runtime.jsx)(index_module.EK,{block:!0,children:JSON.stringify(items.map((item=>({...item,target:item.target?item.target.id:"NONE"}))),void 0,2)})})]})}const Annotations=(0,react.forwardRef)((({},ref)=>{const{annotations}=(0,useAnnotationsContext.i)(),cellList=function useCellList(){const{items,getItem,append,insertBefore,insert,remove,update,selectedKeys,setSelectedKeys}=(0,data_dist_import.SH)({getKey:item=>item.id}),reflowBelow=(initialIndex,lowestCell)=>{let prevBottom=lowestCell;console.log("reflowBelow",initialIndex,lowestCell);for(let i=initialIndex+1;i<items.length;i++){const current=items[i];if(!(current.cell<prevBottom))break;current.cell=prevBottom,prevBottom=current.cell+current.height,console.log("shift down",current.id),update(current.id,{...current})}},reflowAbove=(initialIndex,highestCell)=>{let prevTop=highestCell;console.log("reflowAbove",initialIndex,highestCell);for(let i=initialIndex-1;i>=0;i--){const current=items[i];if(!(current.cell+current.height>prevTop))break;current.cell=prevTop-current.height,prevTop=current.cell,console.log("shift up",current.id),update(current.id,{...current})}},getIndex=id=>items.findIndex((i=>i.id===id)),selectedKey=selectedKeys.values().next().value,focused=selectedKey?getItem(selectedKey):void 0;return console.log("useCellList",items),{items,focused,getItem,focus:id=>{const item=getItem(id);if(!item)return;const index=getIndex(id);setSelectedKeys(new Set([id])),update(id,{...item,cell:item.anchorCell}),reflowAbove(index,item.cell),reflowBelow(index,item.cell+item.height)},resetFocus:()=>{setSelectedKeys(new Set([]))},addItem:item=>{if(getItem(item.id))throw new Error("CellListItem already exists with that ID");for(let i=0;i<items.length;i++)if(items[i].anchorCell>=item.anchorCell)return reflowAbove(i,item.anchorCell),reflowBelow(i-1,item.anchorCell+item.height),void insert(i,item);append(item)},removeItem:id=>{remove(id)},updateItem:(id,item)=>{const existing=getItem(id),index=getIndex(id);item.cell!==existing.cell?(reflowAbove(index,item.cell),reflowBelow(index,item.cell+item.height)):item.height!==existing.height&&reflowBelow(index,item.cell+item.height),update(id,item)}}}(),[threads,setThreads]=(0,react.useState)();return(0,react.useEffect)((()=>{if(!annotations)return;console.log("update threads");const filtered=annotations.filter((a=>"replying"!==a.motivation));filtered.sort(((a,b)=>{const aItem=cellList.getItem(a.id),bItem=cellList.getItem(b.id);return aItem&&bItem?aItem.anchorCell-bItem.anchorCell:0})),setThreads(filtered)}),[annotations]),(0,jsx_runtime.jsx)("div",{ref,children:(0,jsx_runtime.jsxs)(Context.Provider,{value:cellList,children:[threads?.map((anno=>(0,jsx_runtime.jsx)(Thread,{node:anno},anno.id))),(0,jsx_runtime.jsx)(Annotations_Debug,{})]})})}));try{Annotations.displayName="Annotations",Annotations.__docgenInfo={description:"",displayName:"Annotations",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Annotations/Annotations.tsx#Annotations"]={docgenInfo:Annotations.__docgenInfo,name:"Annotations",path:"src/components/Annotations/Annotations.tsx#Annotations"})}catch(__react_docgen_typescript_loader_error){}},"./src/components/AnnotationsProvider/AnnotationsProvider.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>AnnotationsProvider});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_hooks_useAnnotations__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/hooks/useAnnotations.ts"),_hooks_useAnnotationPicker__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/hooks/useAnnotationPicker.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/jsx-runtime.js");function AnnotationsProvider({children,initialItems,agent,role}){const ctx=(0,_hooks_useAnnotations__WEBPACK_IMPORTED_MODULE_2__.O)(initialItems,agent,role),[selected,select]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(),selectionCtx=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>({select,selected,deselect:()=>select(void 0)})),[selected]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)(_hooks_useAnnotations__WEBPACK_IMPORTED_MODULE_2__._.Provider,{value:ctx,children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)(_hooks_useAnnotationPicker__WEBPACK_IMPORTED_MODULE_3__._.Provider,{value:selectionCtx,children})})}AnnotationsProvider.displayName="AnnotationsProvider";try{AnnotationsProvider.displayName="AnnotationsProvider",AnnotationsProvider.__docgenInfo={description:"Thin wrapper around the useAnnotations hook.",displayName:"AnnotationsProvider",props:{initialItems:{defaultValue:null,description:"",name:"initialItems",required:!1,type:{name:"Annotation[]"}},agent:{defaultValue:null,description:"The agent to use for newly created annotations",name:"agent",required:!0,type:{name:"AnnotationAgent"}},role:{defaultValue:null,description:"The role for the agent. This is heavily dependent\non the context in which the annotator is used.\n\nFor forms, this could be `Submitter`, `Reviewer`,\n`Analyst`, etc. Roles may also represent individual's\nrelationship to the submission, such as a `Principal Investigator`\nversus a `Co-Investigator` on a study.",name:"role",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/AnnotationsProvider/AnnotationsProvider.tsx#AnnotationsProvider"]={docgenInfo:AnnotationsProvider.__docgenInfo,name:"AnnotationsProvider",path:"src/components/AnnotationsProvider/AnnotationsProvider.tsx#AnnotationsProvider"})}catch(__react_docgen_typescript_loader_error){}},"./src/hooks/useAnchors.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{_:()=>Context,q:()=>useAnchors});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),react_stately__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@react-stately/data/dist/import.mjs"),uuid__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/uuid/dist/esm-browser/v4.js");const Context=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)({});function useAnchors(){const{items,append,update,remove}=(0,react_stately__WEBPACK_IMPORTED_MODULE_1__.SH)({getKey:item=>item.id});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>{const getAnchor=ref=>items.find((a=>a.source===ref.source&&a.annotationId===ref.annotationId));return{items,getAnchor,setAnchor:(source,type,annotationId,target)=>{const existing=getAnchor({source,annotationId});existing?update(existing.id,{...existing,target}):append({id:(0,uuid__WEBPACK_IMPORTED_MODULE_2__.Z)(),type,source,target,annotationId})},addAnchors:anchors=>{anchors.forEach((a=>{const existing=getAnchor(a);existing?update(existing.id,{...existing,target:a.target??existing.target}):append({...a,id:a.id??(0,uuid__WEBPACK_IMPORTED_MODULE_2__.Z)()})}))}}}),[items,append,update,remove])}},"./src/hooks/useAnchorsContext.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{T:()=>useAnchorsContext});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_useAnchors__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/hooks/useAnchors.ts");function useAnchorsContext(){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(_useAnchors__WEBPACK_IMPORTED_MODULE_1__._)}},"./src/hooks/useAnnotationPicker.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{_:()=>Context,i:()=>useAnnotationPicker});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js");const Context=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)({});function useAnnotationPicker(){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(Context)}},"./src/hooks/useAnnotations.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{O:()=>useAnnotations,_:()=>Context});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),uuid__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/uuid/dist/esm-browser/v4.js"),react_stately__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@react-stately/data/dist/import.mjs");const Context=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)({});function useAnnotations(initialItems=[],agent,role){const{items,selectedKeys,getItem,append,update,setSelectedKeys}=(0,react_stately__WEBPACK_IMPORTED_MODULE_1__.SH)({initialItems,getKey:anno=>anno.id});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>{const focusedAnnotationID=selectedKeys.values().next().value;return{annotations:items,focused:focusedAnnotationID?getItem(focusedAnnotationID):void 0,focus(id,target){setSelectedKeys(new Set([id]))},clearFocus(){console.log("clearFocus"),setSelectedKeys(new Set)},createThread(source,motivation,selector,id){const now=(new Date).toISOString(),anno={"@context":"http://www.w3.org/ns/anno.jsonld",type:"Annotation",id:id??(0,uuid__WEBPACK_IMPORTED_MODULE_2__.Z)(),motivation,created:now,modified:now,creator:agent,target:{source,selector},body:[{type:"TextualBody",value:"",format:"text/html",language:"en"},{type:"Thread",role,requiresResponse:!1,resolved:!1,deleted:!1,recoverable:!0}]};return append(anno),setSelectedKeys(new Set([anno.id])),anno},createReply(source,message,id){const now=(new Date).toISOString(),anno={"@context":"http://www.w3.org/ns/anno.jsonld",type:"Annotation",id:id??(0,uuid__WEBPACK_IMPORTED_MODULE_2__.Z)(),motivation:"replying",created:now,modified:now,creator:agent,target:{source},body:[{type:"TextualBody",value:message,format:"text/html",language:"en"},{type:"ThreadReply",role,deleted:!1,recoverable:!0}]};return append(anno),anno},patch(id,action){const anno=getItem(id);update(id,action(anno))},updateBody:(type,id,action)=>{const anno=getItem(id);update(id,{...anno,body:anno.body.map((b=>b.type===type?action(b):b))})}}}),[items,selectedKeys,agent,role])}},"./src/hooks/useAnnotationsContext.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{i:()=>useAnnotationsContext});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_useAnnotations__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/hooks/useAnnotations.ts");function useAnnotationsContext(){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(_useAnnotations__WEBPACK_IMPORTED_MODULE_1__._)}},"./src/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function isInViewport(window,rect){return!(!window||!document)&&(rect.y>=window.scrollY&&rect.x>=window.scrollX&&rect.y+rect.height<=window.scrollY+window.innerHeight&&rect.x+rect.width<=window.scrollX+window.innerWidth)}function getDocumentPosition(el){const doc=el.ownerDocument,win=doc.defaultView;if(!win)return{top:-1,left:-1};const rect=el.getBoundingClientRect(),scrollLeft=win.scrollY||doc.documentElement.scrollLeft,scrollTop=win.scrollY||doc.documentElement.scrollTop;if(win.frameElement){const framePosition=getDocumentPosition(win.frameElement);return{top:framePosition.top+rect.top+scrollTop,left:framePosition.left+rect.left+scrollLeft}}return{top:rect.top+scrollTop,left:rect.left+scrollLeft}}__webpack_require__.d(__webpack_exports__,{m:()=>getDocumentPosition,v4:()=>isInViewport})}}]);
//# sourceMappingURL=479.350f0ebb.iframe.bundle.js.map